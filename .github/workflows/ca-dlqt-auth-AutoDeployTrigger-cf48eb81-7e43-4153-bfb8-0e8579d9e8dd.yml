name: Trigger auto deployment for ca-dlqt-auth

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
    - '**'
    - '.github/workflows/ca-dlqt-auth-AutoDeployTrigger-cf48eb81-7e43-4153-bfb8-0e8579d9e8dd.yml'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write #This is required for requesting the OIDC JWT Token
      contents: read #Required when GH token is used to authenticate with private repo

    steps:
    - name: Checkout to the branch
      uses: actions/checkout@v2

    - name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.CADLQTAUTH_AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.CADLQTAUTH_AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.CADLQTAUTH_AZURE_SUBSCRIPTION_ID }}

    - name: Build and push container image to registry
      uses: azure/container-apps-deploy-action@v2
      with:
        appSourcePath: ${{ github.workspace }}/auth
        _dockerfilePathKey_: _dockerfilePath_
        _targetLabelKey_: _targetLabel_
        registryUrl: acrdlqt.azurecr.io
        registryUsername: ${{ secrets.CADLQTAUTH_REGISTRY_USERNAME }}
        registryPassword: ${{ secrets.CADLQTAUTH_REGISTRY_PASSWORD }}
        containerAppName: ca-dlqt-auth
        resourceGroup: rg-dlqt
        imageToBuild: acrdlqt.azurecr.io/ca-dlqt-auth:${{ github.sha }}
        _buildArgumentsKey_: |
          _buildArgumentsValues_
